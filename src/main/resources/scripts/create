DROP DATABASE IF EXISTS nfl;
CREATE DATABASE IF NOT EXISTS nfl;
USE nfl;

CREATE TABLE fantasy_team (

	id INT,
    team_name VARCHAR(30) NOT NULL,
    owner_name VARCHAR(20),
    CONSTRAINT fantasy_team_pk PRIMARY KEY (id)

);

CREATE TABLE nfl_team (

	id INT,
    team_name VARCHAR(3) NOT NULL,
    full_name VARCHAR(25) NOT NULL,
    CONSTRAINT nfl_team_pk PRIMARY KEY (id)

);

CREATE TABLE players (
	id INT,
    player_name VARCHAR(70) NOT NULL,
    position ENUM ('QB', 'WR', 'RB', 'TE', 'DST', 'K', 'DL', 'LB', 'DB') NOT NULL,
    nfl_team INT,
    rookie BOOLEAN,
    age DECIMAL(3,1),
    height_feet INT,
    height_inches INT,
    weight INT,
    seasons_experience INT,
    pick_round INT,
    pick_num INT,
    player_number INT,
    birthday DATE,
    draft_year INT,
    college VARCHAR(70),
    fantasy_team INT DEFAULT NULL,
    CONSTRAINT players_pk PRIMARY KEY (id),
    CONSTRAINT players_fk1 FOREIGN KEY (nfl_team) REFERENCES nfl_team (id),
    CONSTRAINT players_fk2 FOREIGN KEY (fantasy_team) REFERENCES fantasy_team (id)
);

CREATE TABLE ktc_info (
    ktc_id INT,
    slug VARCHAR(70),
    player_id INT,

    CONSTRAINT ktc_info_pk PRIMARY KEY (ktc_id),
    CONSTRAINT ktc_info_fk1 FOREIGN KEY (player_id) REFERENCES players (id)
);



CREATE TABLE standard_value_history (
	id INT AUTO_INCREMENT,
	player_id INT NOT NULL,
    date DATE NOT NULL,
    value INT NOT NULL,
    CONSTRAINT standard_value_history_pk PRIMARY KEY (id),
	CONSTRAINT standard_value_history_fk1 FOREIGN KEY (player_id) REFERENCES players (id)

);

CREATE TABLE superflex_value_history (
	id INT AUTO_INCREMENT,
	player_id INT NOT NULL,
    date DATE NOT NULL,
    value INT NOT NULL,
    CONSTRAINT superflex_value_history_pk PRIMARY KEY (id),
	CONSTRAINT superflex_value_history_fk1 FOREIGN KEY (player_id) REFERENCES players (id)

);

CREATE TABLE offensive_player_stats (
    player_id INT,
    season INT,
    week INT,
    opponent INT,
    completions INT,
    incomplete_passes INT,
    passing_yards INT,
    passing_touchdowns INT,
    interceptions INT,
    times_sacked INT,
    rush_yards INT,
    rush_touchdowns INT,
    receptions INT,
    receiving_yards INT,
    receiving_touchdowns INT,
    return_yards INT,
    return_touchdowns INT,
    fumble_return_touchdowns INT,
    two_point_conversions INT,
    fumbles_lost INT,
    fantasy_points DECIMAL(5,2),
    
    CONSTRAINT offensive_player_stats_pk PRIMARY KEY (player_id, season, week),
	CONSTRAINT offensive_player_stats_fk1 FOREIGN KEY (player_id) REFERENCES players(id),
    CONSTRAINT offensive_player_stats_fk2 FOREIGN KEY (opponent) REFERENCES nfl_team(id)
);

CREATE TABLE defensive_player_stats (
    player_id INT,
    season INT,
    week INT,
    opponent INT,
    total_tackles INT,
    assisted_tackles INT,
    sacks DECIMAL(2,1),
    tackles_for_loss INT,
    sack_yards DECIMAL(3,1),
    interceptions INT,
    forced_fumbles INT,
    fumbles_recovered INT,
    interceptions_touchdown INT,
    fumbles_touchdown INT,
    blocked_kick_touchdowns INT,
    safeties INT,
    blocked_kicks INT,
    pass_deflections INT,
    quarterback_hits INT,
    interception_return_yards INT,
    fumble_return_yards INT,
    fantasy_points DECIMAL(5,2),

    CONSTRAINT defensive_player_stats_pk PRIMARY KEY (player_id, season, week),
    CONSTRAINT defensive_player_stats_fk1 FOREIGN KEY (player_id) REFERENCES players(id),
    CONSTRAINT defensive_player_stats_fk2 FOREIGN KEY (opponent) REFERENCES nfl_team(id)
);



CREATE TABLE fantasy_draft (
	id INT AUTO_INCREMENT,
	player_id INT NOT NULL,
    fantasy_team INT NOT NULL,
    draft_year INT NOT NULL,
    pick_round INT NOT NULL,
    pick_num INT NOT NULL,
    pick_overall INT NOT NULL,
    keeper BOOLEAN NOT NULL,
    CONSTRAINT fantasy_draft_pk PRIMARY KEY (id),
    CONSTRAINT fantasy_draft_fk1 FOREIGN KEY (player_id) REFERENCES players(id),
    CONSTRAINT fantasy_draft_fk2 FOREIGN KEY (fantasy_team) REFERENCES fantasy_team(id)
);


DROP TRIGGER IF EXISTS update_after_fantasy_draft;
DELIMITER $$
CREATE TRIGGER update_after_fantasy_draft
AFTER INSERT ON fantasy_draft
FOR EACH ROW
BEGIN
	UPDATE players SET fantasy_team = NEW.fantasy_team WHERE id = NEW.player_id;
END;
$$
DELIMITER ;

CREATE TABLE fantasy_transactions (
    id INT AUTO_INCREMENT,
    player_id INT,
    transaction_type ENUM('add', 'drop', 'trade') NOT NULL,
    week INT,
    source_team INT,
    destination_team INT,
    transaction_date DATETIME NOT NULL,
    CONSTRAINT fantasy_transactions_pk PRIMARY KEY (id),
    CONSTRAINT fantasy_transactions_fk1 FOREIGN KEY (player_id) REFERENCES players (id),
    CONSTRAINT fantasy_transactions_fk2 FOREIGN KEY (source_team) REFERENCES fantasy_team (id),
    CONSTRAINT fantasy_transactions_fk3 FOREIGN KEY (destination_team) REFERENCES fantasy_team (id)
);

DROP TRIGGER IF EXISTS after_insert_movement;
DELIMITER $$
CREATE TRIGGER after_insert_movement
AFTER INSERT ON fantasy_transactions
FOR EACH ROW
BEGIN
    IF NEW.transaction_type = 'add' OR 'trade' THEN
        UPDATE players SET fantasy_team = NEW.fantasy_team_id WHERE id = NEW.player_id;
    ELSE
        UPDATE players SET fantasy_team = NULL WHERE id = NEW.player_id;
    END IF;
END;
$$
DELIMITER ;